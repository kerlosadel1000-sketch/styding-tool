<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LectureLens â€“ Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&family=IBM+Plex+Mono:wght@400;500&family=Cairo:wght@400;600;700&display=swap');

  :root {
    --bg: #0a0a0f;
    --surface: #13131a;
    --surface2: #1c1c28;
    --accent: #00e5ff;
    --accent2: #ff6b35;
    --accent3: #7c3aed;
    --text: #e8e8f0;
    --text-dim: #7a7a9a;
    --border: rgba(0,229,255,0.12);
    --glow: 0 0 20px rgba(0,229,255,0.15);
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Cairo', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Animated bg */
  body::before {
    content:'';
    position:fixed; inset:0;
    background: 
      radial-gradient(ellipse 60% 40% at 20% 10%, rgba(0,229,255,0.05) 0%, transparent 60%),
      radial-gradient(ellipse 50% 30% at 80% 80%, rgba(124,58,237,0.07) 0%, transparent 60%);
    pointer-events:none; z-index:0;
  }

  header {
    position:relative; z-index:10;
    display:flex; align-items:center; justify-content:space-between;
    padding: 18px 28px;
    border-bottom: 1px solid var(--border);
    background: rgba(10,10,15,0.8);
    backdrop-filter: blur(12px);
  }

  .logo {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 1.4rem;
    color: var(--accent);
    letter-spacing:-0.5px;
    display:flex; align-items:center; gap:8px;
  }
  .logo span { color: var(--text-dim); font-weight:400; font-size:0.85rem; }

  .status-pill {
    display:flex; align-items:center; gap:8px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius:999px;
    padding:6px 14px;
    font-size:0.8rem;
    color: var(--text-dim);
  }
  .status-dot {
    width:8px; height:8px; border-radius:50%;
    background: #333;
    transition: background 0.3s;
  }
  .status-dot.active { background: #00e87a; box-shadow:0 0 8px #00e87a; animation: pulse 1.5s infinite; }
  .status-dot.paused { background: var(--accent2); box-shadow:0 0 8px var(--accent2); }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

  main {
    position:relative; z-index:5;
    display:grid;
    grid-template-columns: 1fr 340px;
    gap:0;
    height: calc(100vh - 65px);
  }

  /* TRANSCRIPT PANEL */
  .transcript-panel {
    display:flex; flex-direction:column;
    border-right: 1px solid var(--border);
    overflow:hidden;
  }

  .panel-header {
    display:flex; align-items:center; justify-content:space-between;
    padding:14px 20px;
    border-bottom:1px solid var(--border);
    background: var(--surface);
  }

  .panel-title {
    font-family:'Syne',sans-serif;
    font-weight:700;
    font-size:0.85rem;
    text-transform:uppercase;
    letter-spacing:2px;
    color: var(--text-dim);
  }

  .controls {
    display:flex; gap:8px; align-items:center;
  }

  .btn {
    display:flex; align-items:center; gap:6px;
    padding:8px 16px;
    border-radius:8px;
    border:1px solid var(--border);
    background: var(--surface2);
    color: var(--text);
    font-family:'Cairo',sans-serif;
    font-size:0.82rem;
    cursor:pointer;
    transition: all 0.2s;
  }
  .btn:hover { border-color: var(--accent); color: var(--accent); box-shadow: var(--glow); }
  .btn.primary {
    background: var(--accent);
    color: #000;
    border-color: var(--accent);
    font-weight:700;
  }
  .btn.primary:hover { background: #00c8e0; box-shadow: 0 0 24px rgba(0,229,255,0.4); }
  .btn.danger { border-color: rgba(255,107,53,0.3); }
  .btn.danger:hover { border-color: var(--accent2); color: var(--accent2); }
  .btn:disabled { opacity:0.4; cursor:not-allowed; }

  .transcript-content {
    flex:1; overflow-y:auto;
    padding:20px;
    scroll-behavior:smooth;
  }
  .transcript-content::-webkit-scrollbar { width:4px; }
  .transcript-content::-webkit-scrollbar-track { background:transparent; }
  .transcript-content::-webkit-scrollbar-thumb { background:var(--border); border-radius:99px; }

  .empty-state {
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    height:100%;
    gap:16px;
    color: var(--text-dim);
    text-align:center;
  }
  .empty-icon { font-size:3rem; opacity:0.3; }
  .empty-state h3 { font-size:1rem; color: var(--text-dim); font-weight:600; }
  .empty-state p { font-size:0.82rem; max-width:260px; line-height:1.6; }

  /* Transcript segments */
  .segment {
    margin-bottom:16px;
    padding:14px 16px;
    background: var(--surface);
    border:1px solid var(--border);
    border-radius:12px;
    transition: border-color 0.2s;
    animation: slideIn 0.3s ease;
  }
  @keyframes slideIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:none} }

  .segment:hover { border-color: rgba(0,229,255,0.25); }

  .segment-meta {
    display:flex; justify-content:space-between; align-items:center;
    margin-bottom:8px;
  }
  .segment-time {
    font-family:'IBM Plex Mono',monospace;
    font-size:0.72rem;
    color: var(--accent);
    opacity:0.7;
  }
  .segment-actions { display:flex; gap:6px; opacity:0; transition:opacity 0.2s; }
  .segment:hover .segment-actions { opacity:1; }
  .seg-btn {
    padding:3px 8px;
    border:1px solid var(--border);
    border-radius:5px;
    background:transparent;
    color:var(--text-dim);
    font-size:0.72rem;
    cursor:pointer;
    transition: all 0.15s;
    font-family:'Cairo',sans-serif;
  }
  .seg-btn:hover { border-color:var(--accent); color:var(--accent); }

  .segment-text {
    font-family:'IBM Plex Mono',monospace;
    font-size:0.88rem;
    line-height:1.8;
    color: var(--text);
    direction:ltr; text-align:left;
  }

  .segment-text .word {
    display:inline;
    cursor:pointer;
    border-radius:3px;
    padding:1px 2px;
    transition: background 0.15s;
    position:relative;
  }
  .segment-text .word:hover { background:rgba(0,229,255,0.15); color:var(--accent); }

  .segment-arabic {
    margin-top:10px;
    padding:10px;
    background:rgba(124,58,237,0.08);
    border:1px solid rgba(124,58,237,0.2);
    border-radius:8px;
    font-size:0.85rem;
    line-height:1.7;
    color: #c4b5fd;
    direction:rtl; text-align:right;
    display:none;
  }

  /* Word tooltip */
  .word-tooltip {
    position:fixed;
    background: var(--surface2);
    border:1px solid var(--accent);
    border-radius:10px;
    padding:12px 14px;
    max-width:240px;
    font-size:0.82rem;
    z-index:1000;
    box-shadow:0 8px 32px rgba(0,0,0,0.5), var(--glow);
    pointer-events:none;
    opacity:0;
    transform:translateY(4px);
    transition:opacity 0.15s, transform 0.15s;
    direction:rtl; text-align:right;
  }
  .word-tooltip.visible { opacity:1; transform:none; }
  .tooltip-word { font-family:'Syne',sans-serif; font-weight:700; color:var(--accent); font-size:0.95rem; direction:ltr; text-align:left; }
  .tooltip-ar { color:var(--text-dim); margin-top:4px; font-size:0.8rem; }

  /* Term highlight */
  .term-highlight {
    background:rgba(255,107,53,0.12);
    border-bottom:2px solid var(--accent2);
    border-radius:3px;
    cursor:pointer;
  }
  .term-highlight:hover { background:rgba(255,107,53,0.25); }

  /* Interim text */
  .interim-segment {
    margin-bottom:12px;
    padding:12px 16px;
    border:1px dashed rgba(0,229,255,0.2);
    border-radius:10px;
    font-family:'IBM Plex Mono',monospace;
    font-size:0.85rem;
    color: var(--text-dim);
    direction:ltr; text-align:left;
    animation: blink-border 1.5s infinite;
  }
  @keyframes blink-border { 0%,100%{border-color:rgba(0,229,255,0.2)} 50%{border-color:rgba(0,229,255,0.5)} }

  /* SIDEBAR */
  .sidebar {
    display:flex; flex-direction:column;
    background: var(--surface);
    overflow:hidden;
  }

  .sidebar-tabs {
    display:flex;
    border-bottom:1px solid var(--border);
  }
  .tab {
    flex:1; padding:12px 8px;
    text-align:center;
    font-size:0.78rem;
    font-weight:600;
    color:var(--text-dim);
    cursor:pointer;
    border-bottom:2px solid transparent;
    transition: all 0.2s;
  }
  .tab.active { color:var(--accent); border-bottom-color:var(--accent); }

  .tab-content { flex:1; overflow-y:auto; padding:16px; display:none; }
  .tab-content.active { display:block; }
  .tab-content::-webkit-scrollbar { width:3px; }
  .tab-content::-webkit-scrollbar-thumb { background:var(--border); }

  /* AI Chat */
  .chat-messages {
    display:flex; flex-direction:column; gap:10px;
    margin-bottom:12px;
  }

  .chat-msg {
    padding:10px 12px;
    border-radius:10px;
    font-size:0.82rem;
    line-height:1.7;
    animation: slideIn 0.2s ease;
  }
  .chat-msg.user {
    background:rgba(0,229,255,0.08);
    border:1px solid rgba(0,229,255,0.15);
    color:var(--accent);
    direction:rtl; text-align:right;
    margin-left:20px;
  }
  .chat-msg.assistant {
    background:var(--surface2);
    border:1px solid var(--border);
    direction:rtl; text-align:right;
    margin-right:20px;
  }
  .chat-msg.loading { color:var(--text-dim); }

  .chat-input-area {
    display:flex; gap:6px;
  }
  .chat-input {
    flex:1;
    background:var(--surface2);
    border:1px solid var(--border);
    border-radius:8px;
    padding:8px 12px;
    color:var(--text);
    font-family:'Cairo',sans-serif;
    font-size:0.82rem;
    direction:rtl;
    outline:none;
    transition:border-color 0.2s;
    resize:none;
  }
  .chat-input:focus { border-color:var(--accent); }
  .send-btn {
    padding:8px 12px;
    background:var(--accent);
    color:#000;
    border:none;
    border-radius:8px;
    cursor:pointer;
    font-size:1rem;
    font-weight:700;
    transition: all 0.2s;
  }
  .send-btn:hover { background:#00c8e0; }
  .send-btn:disabled { opacity:0.4; cursor:not-allowed; }

  /* Saved items */
  .saved-item {
    padding:10px 12px;
    background:var(--surface2);
    border:1px solid var(--border);
    border-radius:8px;
    margin-bottom:8px;
    font-size:0.8rem;
    animation: slideIn 0.3s ease;
  }
  .saved-item-text { font-family:'IBM Plex Mono',monospace; direction:ltr; text-align:left; color:var(--text-dim); margin-bottom:4px; font-size:0.77rem; }
  .saved-item-time { font-size:0.7rem; color: var(--accent); opacity:0.5; }
  .saved-item-actions { display:flex; gap:4px; margin-top:8px; flex-wrap:wrap; }

  /* Terms panel */
  .term-card {
    padding:12px;
    background:var(--surface2);
    border:1px solid rgba(255,107,53,0.2);
    border-radius:8px;
    margin-bottom:8px;
    cursor:pointer;
    transition:all 0.2s;
  }
  .term-card:hover { border-color:var(--accent2); }
  .term-name { font-family:'Syne',sans-serif; font-weight:700; color:var(--accent2); font-size:0.9rem; }
  .term-def { font-size:0.78rem; color:var(--text-dim); margin-top:4px; line-height:1.6; direction:rtl; text-align:right; }

  /* Bottom controls */
  .bottom-controls {
    padding:14px 20px;
    border-top:1px solid var(--border);
    background:var(--surface);
    display:flex; gap:8px; align-items:center; flex-wrap:wrap;
  }

  .mic-btn {
    display:flex; align-items:center; justify-content:center; gap:8px;
    padding:12px 24px;
    border-radius:50px;
    border:2px solid var(--border);
    background:var(--surface2);
    color:var(--text);
    font-family:'Cairo',sans-serif;
    font-size:0.9rem;
    font-weight:700;
    cursor:pointer;
    transition:all 0.3s;
  }
  .mic-btn.listening {
    background:rgba(0,232,122,0.08);
    border-color:#00e87a;
    color:#00e87a;
    box-shadow:0 0 24px rgba(0,232,122,0.2);
  }
  .mic-btn.paused-state {
    background:rgba(255,107,53,0.08);
    border-color:var(--accent2);
    color:var(--accent2);
  }

  .lang-select {
    background:var(--surface2);
    border:1px solid var(--border);
    border-radius:8px;
    padding:10px 14px;
    color:var(--text);
    font-family:'Cairo',sans-serif;
    font-size:0.82rem;
    cursor:pointer;
    outline:none;
  }
  .lang-select:focus { border-color:var(--accent); }

  /* Context menu */
  .context-menu {
    position:fixed;
    background:var(--surface2);
    border:1px solid var(--border);
    border-radius:10px;
    padding:6px;
    z-index:2000;
    min-width:180px;
    box-shadow:0 12px 40px rgba(0,0,0,0.6);
    display:none;
  }
  .context-item {
    padding:8px 12px;
    border-radius:6px;
    font-size:0.82rem;
    cursor:pointer;
    transition:background 0.15s;
    display:flex; align-items:center; gap:8px;
  }
  .context-item:hover { background:rgba(0,229,255,0.08); color:var(--accent); }
  .context-sep { height:1px; background:var(--border); margin:4px 0; }

  /* Term popup */
  .term-popup {
    position:fixed;
    background:var(--surface2);
    border:1px solid var(--accent2);
    border-radius:12px;
    padding:16px;
    max-width:320px;
    z-index:3000;
    box-shadow:0 12px 50px rgba(0,0,0,0.7);
    display:none;
    animation:slideIn 0.2s ease;
  }
  .term-popup-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
  .term-popup-word { font-family:'Syne',sans-serif; font-weight:800; color:var(--accent2); font-size:1.1rem; direction:ltr; }
  .close-popup { background:none; border:none; color:var(--text-dim); cursor:pointer; font-size:1.2rem; }
  .term-popup-content { font-size:0.82rem; line-height:1.7; direction:rtl; text-align:right; }
  .term-popup-loading { color:var(--text-dim); text-align:center; padding:10px 0; }

  .notification {
    position:fixed; bottom:24px; left:50%; transform:translateX(-50%);
    background:var(--surface2);
    border:1px solid var(--accent);
    padding:10px 20px;
    border-radius:99px;
    font-size:0.82rem;
    color:var(--accent);
    z-index:5000;
    opacity:0;
    transition:opacity 0.3s;
    pointer-events:none;
    white-space:nowrap;
  }
  .notification.show { opacity:1; }

  @media(max-width:768px) {
    main { grid-template-columns:1fr; grid-template-rows:1fr 300px; }
    .transcript-panel { border-right:none; border-bottom:1px solid var(--border); }
  }
</style>
</head>
<body>

<header>
  <div class="logo">ğŸ“ LectureLens <span>Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</span></div>
  <div style="display:flex;align-items:center;gap:10px">
    <button class="btn" onclick="showKeyModal()" style="font-size:0.78rem">ğŸ”‘ AI Key</button>
    <div class="status-pill">
      <div class="status-dot" id="statusDot"></div>
      <span id="statusText">Ù…ØªÙˆÙ‚Ù</span>
    </div>
  </div>
</header>

<!-- YouTube bar -->
<div id="ytBar" style="display:none;padding:10px 20px;background:var(--surface2);border-bottom:1px solid var(--border)">
  <div style="display:flex;gap:8px;align-items:center">
    <span>â–¶ï¸</span>
    <input id="ytInput" type="url" placeholder="https://www.youtube.com/watch?v=..."
      onkeydown="if(event.key==='Enter')fetchYTTranscript()"
      style="flex:1;padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);font-size:0.82rem;outline:none;direction:ltr">
    <button class="btn primary" onclick="fetchYTTranscript()">Ø¬ÙŠØ¨ Ø§Ù„ÙƒØ§Ø¨Ø´Ù†</button>
    <button class="btn" onclick="document.getElementById('ytBar').style.display='none'">âœ•</button>
  </div>
  <p id="ytStatus" style="font-size:0.78rem;color:var(--text-dim);margin-top:6px;direction:rtl"></p>
</div>

<main>
  <div class="transcript-panel">
    <div class="panel-header">
      <span class="panel-title">ğŸ“ Ø§Ù„Ù†Øµ Ø§Ù„Ù…ÙÙØ±ÙÙ‘Øº</span>
      <div class="controls">
        <button class="btn" onclick="document.getElementById('ytBar').style.display=document.getElementById('ytBar').style.display==='none'?'block':'none'">â–¶ï¸ YouTube</button>
        <button class="btn" onclick="clearTranscript()">ğŸ—‘ï¸ Ù…Ø³Ø­</button>
        <button class="btn" onclick="copyAll()">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„ÙƒÙ„</button>
        <button class="btn" id="showTermsBtn" onclick="toggleAutoTerms()">ğŸ” Ø§Ù„Ù…ØµØ·Ù„Ø­Ø§Øª</button>
      </div>
    </div>
    <div class="transcript-content" id="transcriptContent">
      <div class="empty-state" id="emptyState">
        <div class="empty-icon">ğŸ™ï¸</div>
        <h3>ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©</h3>
        <p>Ø§Ø¶ØºØ· Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ø£Ùˆ Ø­Ø· Ø±Ø§Ø¨Ø· YouTube</p>
      </div>
    </div>
    <div class="bottom-controls">
      <button class="mic-btn" id="micBtn" onclick="toggleListening()">
        <span id="micIcon">ğŸ™ï¸</span>
        <span id="micLabel">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹</span>
      </button>
      <select class="lang-select" id="langSelect">
        <option value="en-US">ğŸ‡ºğŸ‡¸ English (US)</option>
        <option value="en-GB">ğŸ‡¬ğŸ‡§ English (UK)</option>
        <option value="ar-EG">ğŸ‡ªğŸ‡¬ Ø¹Ø±Ø¨ÙŠ</option>
      </select>
      <button class="btn" id="pauseBtn" onclick="pauseResume()" disabled>â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª</button>
    </div>
  </div>

  <div class="sidebar">
    <div class="sidebar-tabs">
      <div class="tab active" onclick="switchTab('chat')">ğŸ¤– AI Ù…Ø³Ø§Ø¹Ø¯</div>
      <div class="tab" onclick="switchTab('saved')">ğŸ“Œ Ù…Ø­ÙÙˆØ¸Ø§Øª</div>
      <div class="tab" onclick="switchTab('terms')">ğŸ“š Ù…ØµØ·Ù„Ø­Ø§Øª</div>
    </div>
    <div class="tab-content active" id="tab-chat">
      <div class="chat-messages" id="chatMessages">
        <div class="chat-msg assistant">Ø£Ù‡Ù„Ø§Ù‹! Ø§Ø³Ø£Ù„Ù†ÙŠ Ø¹Ù† Ø£ÙŠ Ø­Ø§Ø¬Ø© ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© ğŸ“</div>
      </div>
      <div class="chat-input-area">
        <textarea class="chat-input" id="chatInput" placeholder="Ø§Ø³Ø£Ù„ Ø¹Ù† Ø­Ø§Ø¬Ø©..." rows="2" onkeydown="handleChatKey(event)"></textarea>
        <button class="send-btn" id="sendBtn" onclick="sendChat()">â†‘</button>
      </div>
    </div>
    <div class="tab-content" id="tab-saved">
      <div id="savedList"><p style="color:var(--text-dim);font-size:0.82rem;text-align:center;padding:20px 0">Ù„Ø³Ù‡ Ù…Ø§Ø­ÙØ¸ØªÙŠØ´ Ø­Ø§Ø¬Ø© ğŸ“Œ</p></div>
    </div>
    <div class="tab-content" id="tab-terms">
      <div id="termsList"><p style="color:var(--text-dim);font-size:0.82rem;text-align:center;padding:20px 0">Ø§Ù„Ù…ØµØ·Ù„Ø­Ø§Øª Ù‡ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ ğŸ“š</p></div>
    </div>
  </div>
</main>

<div class="word-tooltip" id="wordTooltip">
  <div class="tooltip-word" id="tooltipWord"></div>
  <div class="tooltip-ar" id="tooltipAr"></div>
</div>

<div class="context-menu" id="contextMenu">
  <div class="context-item" id="ctxSelBtn" style="display:none" onclick="ctxTranslateSelected()">ğŸŒ ØªØ±Ø¬Ù… Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø­Ø¯Ø¯</div>
  <div class="context-item" onclick="ctxTranslateFull()">ğŸŒ ØªØ±Ø¬Ù… Ø§Ù„Ø¬Ù…Ù„Ø© ÙƒÙ„Ù‡Ø§</div>
  <div class="context-item" onclick="explainSelection()">ğŸ¤– ÙØ³Ù‘Ø±Ù„ÙŠ Ø¨Ø§Ù„Ù€ AI</div>
  <div class="context-item" onclick="saveSelection()">ğŸ“Œ Ø­ÙØ¸</div>
  <div class="context-sep"></div>
  <div class="context-item" onclick="copySelection()">ğŸ“‹ Ù†Ø³Ø®</div>
  <div class="context-item" onclick="searchTerm()">ğŸ” Ø¬ÙˆØ¬Ù„</div>
</div>

<div class="term-popup" id="termPopup">
  <div class="term-popup-header">
    <span class="term-popup-word" id="termPopupWord"></span>
    <button class="close-popup" onclick="document.getElementById('termPopup').style.display='none'">âœ•</button>
  </div>
  <div class="term-popup-content" id="termPopupContent"></div>
</div>

<div id="keyModal" style="display:none;position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.8);backdrop-filter:blur(6px);align-items:center;justify-content:center">
  <div style="background:#1c1c28;border:1px solid rgba(0,229,255,0.3);border-radius:16px;padding:28px;width:min(400px,92vw)">
    <h3 style="font-family:Syne,sans-serif;color:#00e5ff;margin-bottom:10px">ğŸ¤– API Key Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h3>
    <p style="color:#7a7a9a;font-size:0.82rem;line-height:1.7;direction:rtl;margin-bottom:14px">
      Ø§Ù„ØªØ±Ø¬Ù…Ø© âœ… Ù…Ø¬Ø§Ù†ÙŠØ© Ø¨Ø¯ÙˆÙ† key.<br>
      Ù…Ø²Ø§ÙŠØ§ Ø§Ù„Ù€ AI ØªØ­ØªØ§Ø¬ key Ù…Ù†:
      <a href="https://console.anthropic.com" target="_blank" style="color:#00e5ff">console.anthropic.com</a>
      â† API Keys â† Create Key<br>
      <span style="color:#e8e8f0">Ø§Ù„Ù€ Key Ø¨ÙŠØªØ­ÙØ¸ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ Ø¨Ø³.</span>
    </p>
    <input id="keyInput" type="password" placeholder="sk-ant-api03-..."
      onkeydown="if(event.key==='Enter')submitKey()"
      style="width:100%;padding:10px 14px;border-radius:8px;border:1px solid rgba(0,229,255,0.2);background:#0a0a0f;color:#e8e8f0;font-family:monospace;font-size:0.85rem;outline:none;margin-bottom:8px;direction:ltr;box-sizing:border-box">
    <p id="keyError" style="display:none;color:#ff6b35;font-size:0.78rem;margin-bottom:8px;direction:rtl">âš ï¸ Ø§Ù„Ù€ Key Ù„Ø§Ø²Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ù€ sk-ant-</p>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button onclick="document.getElementById('keyModal').style.display='none'" style="padding:8px 16px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:transparent;color:#7a7a9a;cursor:pointer;font-family:Cairo,sans-serif">ØªØ®Ø·Ù‘ÙŠ</button>
      <button onclick="submitKey()" style="padding:8px 20px;border-radius:8px;border:none;background:#00e5ff;color:#000;font-weight:700;cursor:pointer;font-family:Cairo,sans-serif">Ø­ÙØ¸ âœ“</button>
    </div>
  </div>
</div>

<div class="notification" id="notification"></div>

<script>
'use strict';

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var recognition   = null;
var isListening   = false;
var isPaused      = false;
var segments      = [];
var savedItems    = [];
var detectedTerms = {};
var autoTermsEnabled = true;
var segmentCounter   = 0;
var ctxSegId = null;
var ctxText  = '';
var interimEl    = null;
var activeSegId  = null;
var sessionFired = false;
var silenceTimer = null;
var SILENCE_MS   = 5000;
var ANTHROPIC_KEY = localStorage.getItem('ll_key') || '';

// â”€â”€ API KEY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showKeyModal() {
  document.getElementById('keyModal').style.display = 'flex';
  document.getElementById('keyInput').value = ANTHROPIC_KEY;
  document.getElementById('keyError').style.display = 'none';
}

function submitKey() {
  var v = document.getElementById('keyInput').value.trim();
  if (!v.startsWith('sk-ant-')) {
    document.getElementById('keyError').style.display = 'block';
    return;
  }
  ANTHROPIC_KEY = v;
  localStorage.setItem('ll_key', v);
  document.getElementById('keyModal').style.display = 'none';
  showNotification('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù€ Key');
}

// â”€â”€ TERMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var TERMS = [
  'algorithm','hypothesis','methodology','paradigm','synthesis','analysis',
  'mitosis','meiosis','photosynthesis','osmosis','entropy','quantum',
  'metabolism','neural','cortex','neuron','chromosome','genome','protein',
  'derivative','integral','vector','matrix','polynomial','logarithm',
  'theorem','axiom','corollary','empirical','correlation','regression',
  'amplitude','frequency','wavelength','diffraction','refraction','conductivity',
  'oxidation','reduction','catalyst','equilibrium','isomer','polymer',
  'gdp','inflation','deficit','liability','asset','depreciation',
  'cognitive','behavioral','stimulus','conditioning','perception','linguistics'
];

var TRANS = {
  'algorithm':'Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ©','hypothesis':'ÙØ±Ø¶ÙŠØ©','methodology':'Ù…Ù†Ù‡Ø¬ÙŠØ©',
  'paradigm':'Ù†Ù…ÙˆØ°Ø¬ Ù…Ø±Ø¬Ø¹ÙŠ','synthesis':'ØªÙˆÙ„ÙŠÙ','analysis':'ØªØ­Ù„ÙŠÙ„',
  'mitosis':'Ø§Ù†Ù‚Ø³Ø§Ù… Ù…ØªØ³Ø§ÙˆÙ','meiosis':'Ø§Ù†Ù‚Ø³Ø§Ù… Ø§Ø®ØªØ²Ø§Ù„ÙŠ','photosynthesis':'Ø¨Ù†Ø§Ø¡ Ø¶ÙˆØ¦ÙŠ',
  'osmosis':'ØªÙ†Ø§Ø¶Ø­','entropy':'Ø¥Ù†ØªØ±ÙˆØ¨ÙŠØ§','quantum':'ÙƒÙ…ÙŠ',
  'metabolism':'Ø§Ù„Ø£ÙŠØ¶','neural':'Ø¹ØµØ¨ÙŠ','cortex':'Ù‚Ø´Ø±Ø© Ø§Ù„Ù…Ø®',
  'neuron':'Ø®Ù„ÙŠØ© Ø¹ØµØ¨ÙŠØ©','chromosome':'ÙƒØ±ÙˆÙ…ÙˆØ³ÙˆÙ…','genome':'Ø¬ÙŠÙ†ÙˆÙ…',
  'protein':'Ø¨Ø±ÙˆØªÙŠÙ†','derivative':'Ù…Ø´ØªÙ‚Ø©','integral':'ØªÙƒØ§Ù…Ù„',
  'vector':'Ù…ØªØ¬Ù‡','matrix':'Ù…ØµÙÙˆÙØ©','polynomial':'ÙƒØ«ÙŠØ± Ø§Ù„Ø­Ø¯ÙˆØ¯',
  'logarithm':'Ù„ÙˆØºØ§Ø±ÙŠØªÙ…','theorem':'Ù†Ø¸Ø±ÙŠØ©','axiom':'Ø¨Ø¯ÙŠÙ‡ÙŠØ©',
  'corollary':'Ù†ØªÙŠØ¬Ø©','empirical':'ØªØ¬Ø±ÙŠØ¨ÙŠ','correlation':'Ø§Ø±ØªØ¨Ø§Ø·',
  'regression':'Ø§Ù†Ø­Ø¯Ø§Ø±','amplitude':'Ø³Ø¹Ø©','frequency':'ØªØ±Ø¯Ø¯',
  'wavelength':'Ø·ÙˆÙ„ Ù…ÙˆØ¬ÙŠ','diffraction':'Ø­ÙŠÙˆØ¯','refraction':'Ø§Ù†ÙƒØ³Ø§Ø±',
  'conductivity':'ØªÙˆØµÙŠÙ„ÙŠØ©','oxidation':'Ø£ÙƒØ³Ø¯Ø©','reduction':'Ø§Ø®ØªØ²Ø§Ù„',
  'catalyst':'Ù…Ø­ÙØ²','equilibrium':'ØªÙˆØ§Ø²Ù†','isomer':'Ù…ØªØ´ÙƒÙ„','polymer':'Ø¨ÙˆÙ„ÙŠÙ…Ø±',
  'gdp':'Ø§Ù„Ù†Ø§ØªØ¬ Ø§Ù„Ù…Ø­Ù„ÙŠ','inflation':'ØªØ¶Ø®Ù…','deficit':'Ø¹Ø¬Ø²',
  'liability':'Ø§Ù„ØªØ²Ø§Ù…','asset':'Ø£ØµÙ„','depreciation':'Ø¥Ù‡Ù„Ø§Ùƒ',
  'cognitive':'Ù…Ø¹Ø±ÙÙŠ','behavioral':'Ø³Ù„ÙˆÙƒÙŠ','stimulus':'Ù…Ù†Ø¨Ù‡',
  'conditioning':'ØªØ´Ø±ÙŠØ·','perception':'Ø¥Ø¯Ø±Ø§Ùƒ','linguistics':'Ù„ØºÙˆÙŠØ§Øª'
};

var DEFS = {
  'algorithm':'Ø®Ø·ÙˆØ§Øª Ù…Ù†Ø·Ù‚ÙŠØ© Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø©. Ù‚Ù„Ø¨ Ø§Ù„Ø¨Ø±Ù…Ø¬Ø© ÙˆØ§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ.',
  'hypothesis':'Ø§ÙØªØ±Ø§Ø¶ ÙŠÙØ·Ø±Ø­ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±. Ù„Ø§ ÙŠØµØ¨Ø­ Ø­Ù‚ÙŠÙ‚Ø© Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø«Ø¨Ø§Øª.',
  'photosynthesis':'ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Ø¨Ø§Øª Ù„Ù„Ø¶ÙˆØ¡ ÙˆCOâ‚‚ ÙˆØ§Ù„Ù…Ø§Ø¡ Ø¥Ù„Ù‰ Ø³ÙƒØ± ÙˆØ£ÙƒØ³Ø¬ÙŠÙ†.',
  'osmosis':'Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„Ù…Ø§Ø¡ Ø¹Ø¨Ø± ØºØ´Ø§Ø¡ Ù…Ù† ØªØ±ÙƒÙŠØ² Ø¹Ø§Ù„Ù Ù„Ù…Ù†Ø®ÙØ¶.',
  'entropy':'Ù…Ù‚ÙŠØ§Ø³ Ø§Ù„ÙÙˆØ¶Ù‰ ÙÙŠ Ù†Ø¸Ø§Ù…. ÙŠØ²ÙŠØ¯ Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙÙŠ Ø§Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…ØºÙ„Ù‚Ø©.',
  'mitosis':'Ø§Ù†Ù‚Ø³Ø§Ù… Ø§Ù„Ø®Ù„ÙŠØ© Ù„Ø®Ù„ÙŠØªÙŠÙ† Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†.',
  'meiosis':'Ø§Ù†Ù‚Ø³Ø§Ù… ÙŠÙ†ØªØ¬ Ø®Ù„Ø§ÙŠØ§ Ø¬Ù†Ø³ÙŠØ© Ø¨Ù†ØµÙ Ø§Ù„ÙƒØ±ÙˆÙ…ÙˆØ³ÙˆÙ…Ø§Øª.',
  'methodology':'Ø§Ù„Ù…Ù†Ù‡Ø¬ ÙˆØ§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© ÙÙŠ Ø§Ù„Ø¨Ø­Ø«.'
};

// â”€â”€ SPEECH RECOGNITION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initRecognition() {
  var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { showNotification('âŒ Chrome Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± ÙÙ‚Ø·'); return null; }
  var r = new SR();
  r.continuous     = false;
  r.interimResults = true;
  r.lang           = document.getElementById('langSelect').value;
  r.maxAlternatives = 1;

  r.onresult = function(event) {
    clearTimeout(silenceTimer);
    var interim = '';
    for (var i = 0; i < event.results.length; i++) {
      var res = event.results[i];
      if (res.isFinal) {
        if (!sessionFired) {
          sessionFired = true;
          var text = res[0].transcript.trim();
          if (text) {
            appendToActive(text);
            if (interimEl) { interimEl.remove(); interimEl = null; }
          }
        }
      } else {
        interim += res[0].transcript;
      }
    }
    silenceTimer = setTimeout(function() { activeSegId = null; }, SILENCE_MS);
    var c = document.getElementById('transcriptContent');
    if (interim) {
      if (!interimEl) {
        interimEl = document.createElement('div');
        interimEl.className = 'interim-segment';
        c.appendChild(interimEl);
      }
      interimEl.textContent = interim;
      c.scrollTop = 99999;
    } else if (interimEl) {
      interimEl.textContent = '';
    }
  };

  r.onerror = function(e) {
    if (e.error !== 'no-speech' && e.error !== 'aborted')
      showNotification('âš ï¸ ' + e.error);
  };

  r.onend = function() {
    if (interimEl) { interimEl.remove(); interimEl = null; }
    if (isListening && !isPaused) {
      sessionFired = false;
      setTimeout(function() {
        try { r.start(); } catch(e) {}
      }, 50);
    }
  };

  return r;
}

// â”€â”€ SEGMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function appendToActive(text) {
  if (activeSegId !== null) {
    var seg = segments.find(function(s) { return s.id === activeSegId; });
    if (seg) {
      seg.text += ' ' + text;
      var el = document.getElementById('text-' + activeSegId);
      if (el) { el.innerHTML = processText(seg.text, activeSegId); attachWords(el); }
      if (autoTermsEnabled) detectTerms(text);
      document.getElementById('transcriptContent').scrollTop = 99999;
      return;
    }
  }
  addSegment(text);
}

function addSegment(text) {
  var id = ++segmentCounter;
  activeSegId = id;
  var t = new Date().toLocaleTimeString('ar-EG', {hour:'2-digit',minute:'2-digit',second:'2-digit'});
  segments.push({ id:id, text:text, time:t, translated:null });
  document.getElementById('emptyState') && document.getElementById('emptyState').remove();
  var c = document.getElementById('transcriptContent');
  var el = document.createElement('div');
  el.className = 'segment';
  el.id = 'seg-' + id;
  el.innerHTML =
    '<div class="segment-meta">' +
      '<span class="segment-time">' + t + '</span>' +
      '<div class="segment-actions">' +
        '<button class="seg-btn" onclick="translateSeg(' + id + ')">ğŸŒ AR</button>' +
        '<button class="seg-btn" onclick="saveSeg(' + id + ')">ğŸ“Œ</button>' +
        '<button class="seg-btn" onclick="explainSeg(' + id + ')">ğŸ¤–</button>' +
        '<button class="seg-btn" onclick="copySeg(' + id + ')">ğŸ“‹</button>' +
      '</div>' +
    '</div>' +
    '<div class="segment-text" id="text-' + id + '">' + processText(text, id) + '</div>' +
    '<div class="segment-arabic" id="ar-' + id + '"></div>';
  c.appendChild(el);
  c.scrollTop = 99999;
  attachWords(el);
  if (autoTermsEnabled) detectTerms(text);
  el.addEventListener('contextmenu', handleCtx);
}

function processText(text, id) {
  return text.split(' ').map(function(w) {
    var clean = w.replace(/[^a-zA-Z]/g,'').toLowerCase();
    if (TERMS.indexOf(clean) !== -1) {
      return '<span class="word term-highlight" data-word="' + clean + '" onclick="showTermInfo(\'' + clean + '\')">' + w + '</span>';
    }
    return '<span class="word" data-word="' + clean + '">' + w + '</span>';
  }).join(' ');
}

function attachWords(parent) {
  var words = parent.querySelectorAll('.word');
  for (var i = 0; i < words.length; i++) {
    words[i].addEventListener('mouseenter', showTip);
    words[i].addEventListener('mouseleave', hideTip);
  }
}

function detectTerms(text) {
  var words = text.split(' ');
  for (var i = 0; i < words.length; i++) {
    var c = words[i].replace(/[^a-zA-Z]/g,'').toLowerCase();
    if (TERMS.indexOf(c) !== -1 && !detectedTerms[c]) {
      detectedTerms[c] = true;
      var panel = document.getElementById('termsList');
      var p = panel.querySelector('p');
      if (p) p.remove();
      var el = document.createElement('div');
      el.className = 'term-card';
      el.setAttribute('onclick', 'showTermInfo("' + c + '")');
      el.innerHTML = '<div class="term-name">' + c + '</div><div class="term-def">' + (TRANS[c]||'Ø§Ø¶ØºØ· Ù„Ù„Ù…Ø²ÙŠØ¯') + '</div>';
      panel.appendChild(el);
    }
  }
}

// â”€â”€ TOOLTIP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var tip = document.getElementById('wordTooltip');
function showTip(e) {
  var w = e.target.getAttribute('data-word');
  if (!w || w.length < 3) return;
  document.getElementById('tooltipWord').textContent = e.target.textContent;
  document.getElementById('tooltipAr').textContent = TRANS[w] ? 'ğŸ‡ªğŸ‡¬ ' + TRANS[w] : 'ÙƒÙ„ÙŠÙƒ ÙŠÙ…ÙŠÙ† Ù„Ù„Ù…Ø²ÙŠØ¯';
  tip.classList.add('visible');
  tip.style.left = Math.min(e.clientX+12, window.innerWidth-260) + 'px';
  tip.style.top  = Math.max(e.clientY-60, 8) + 'px';
}
function hideTip() { tip.classList.remove('visible'); }

// â”€â”€ TRANSLATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doTranslate(text, callback) {
  fetch('https://api.mymemory.translated.net/get?q=' + encodeURIComponent(text) + '&langpair=en|ar')
    .then(function(r) { return r.json(); })
    .then(function(d) { callback(d.responseData && d.responseData.translatedText || 'âŒ ÙØ´Ù„Øª Ø§Ù„ØªØ±Ø¬Ù…Ø©'); })
    .catch(function() { callback('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„'); });
}

function translateSeg(id) {
  var seg = segments.find(function(s) { return s.id === id; });
  if (!seg) return;
  var el = document.getElementById('ar-' + id);
  if (el.style.display === 'block') { el.style.display = 'none'; return; }
  el.style.display = 'block';
  if (seg.translated) { el.textContent = seg.translated; return; }
  el.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ±Ø¬Ù…Ø©...';
  doTranslate(seg.text, function(result) {
    seg.translated = result;
    el.textContent = result;
  });
}

function ctxTranslateSelected() {
  if (!ctxText) return;
  document.getElementById('contextMenu').style.display = 'none';
  var popup = document.getElementById('termPopup');
  document.getElementById('termPopupWord').textContent = 'ğŸŒ ØªØ±Ø¬Ù…Ø©';
  document.getElementById('termPopupContent').textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ±Ø¬Ù…Ø©...';
  popup.style.display = 'block';
  popup.style.left = '50%'; popup.style.top = '50%';
  popup.style.transform = 'translate(-50%,-50%)';
  doTranslate(ctxText, function(result) {
    document.getElementById('termPopupContent').innerHTML =
      '<p style="direction:ltr;color:var(--text-dim);font-size:0.8rem;margin-bottom:8px">"' + ctxText + '"</p>' +
      '<p style="direction:rtl;color:#c4b5fd;font-size:0.9rem;line-height:1.7">' + result + '</p>';
  });
}

function ctxTranslateFull() {
  document.getElementById('contextMenu').style.display = 'none';
  translateSeg(ctxSegId);
}

function saveSeg(id) {
  var seg = segments.find(function(s) { return s.id === id; });
  if (!seg) return;
  savedItems.push({ text:seg.text, time:seg.time });
  renderSaved();
  showNotification('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸');
}

function explainSeg(id) {
  var seg = segments.find(function(s) { return s.id === id; });
  if (!seg) return;
  switchTab('chat');
  addChatMsg('ÙØ³Ù‘Ø±Ù„ÙŠ: "' + seg.text + '"', 'user');
  callAI('Explain this English lecture sentence to an Arabic student in simple Arabic:\n\n"' + seg.text + '"', function(r) {
    addChatMsg(r, 'assistant');
  });
}

function copySeg(id) {
  var seg = segments.find(function(s) { return s.id === id; });
  if (!seg) return;
  navigator.clipboard.writeText(seg.text).then(function() { showNotification('âœ… Ù†ÙØ³Ø®'); });
}

// â”€â”€ CONTEXT MENU â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleCtx(e) {
  e.preventDefault();
  ctxText  = window.getSelection().toString().trim();
  ctxSegId = parseInt(e.currentTarget.id.replace('seg-',''));
  document.getElementById('ctxSelBtn').style.display = ctxText ? 'flex' : 'none';
  var m = document.getElementById('contextMenu');
  m.style.display = 'block';
  m.style.left = Math.min(e.clientX, window.innerWidth-210) + 'px';
  m.style.top  = Math.min(e.clientY, window.innerHeight-220) + 'px';
}
document.addEventListener('click', function() { document.getElementById('contextMenu').style.display = 'none'; });

function explainSelection() {
  document.getElementById('contextMenu').style.display = 'none';
  var text = ctxText || (segments.find(function(s){return s.id===ctxSegId;})||{}).text || '';
  if (!text) return;
  switchTab('chat');
  addChatMsg('ÙØ³Ù‘Ø±Ù„ÙŠ: "' + text + '"', 'user');
  callAI('Explain this to an Arabic student in simple Arabic:\n\n"' + text + '"', function(r) {
    addChatMsg(r, 'assistant');
  });
}

function saveSelection() {
  document.getElementById('contextMenu').style.display = 'none';
  var text = ctxText || (segments.find(function(s){return s.id===ctxSegId;})||{}).text || '';
  if (!text) return;
  savedItems.push({ text:text, time:new Date().toLocaleTimeString('ar-EG',{hour:'2-digit',minute:'2-digit'}) });
  renderSaved();
  showNotification('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸');
}

function copySelection() {
  document.getElementById('contextMenu').style.display = 'none';
  var text = ctxText || (segments.find(function(s){return s.id===ctxSegId;})||{}).text || '';
  if (text) navigator.clipboard.writeText(text).then(function(){showNotification('âœ… Ù†ÙØ³Ø®');});
}

function searchTerm() {
  document.getElementById('contextMenu').style.display = 'none';
  var text = ctxText || (segments.find(function(s){return s.id===ctxSegId;})||{}).text || '';
  if (text) window.open('https://www.google.com/search?q=' + encodeURIComponent(text + ' definition'), '_blank');
}

// â”€â”€ TERM POPUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showTermInfo(term) {
  var popup = document.getElementById('termPopup');
  document.getElementById('termPopupWord').textContent = term;
  var content = document.getElementById('termPopupContent');
  popup.style.display = 'block';
  popup.style.left = '50%'; popup.style.top = '50%';
  popup.style.transform = 'translate(-50%,-50%)';

  if (DEFS[term]) {
    content.innerHTML =
      '<p>ğŸ‡ªğŸ‡¬ <strong>' + (TRANS[term]||'') + '</strong></p>' +
      '<p style="margin-top:8px">' + DEFS[term] + '</p>' +
      '<a href="https://www.google.com/search?q=' + encodeURIComponent(term+' definition') + '" target="_blank" style="display:inline-block;margin-top:10px;color:var(--accent);font-size:0.78rem">ğŸ”— Ø¬ÙˆØ¬Ù„ â†’</a>';
    return;
  }
  content.innerHTML = '<div class="term-popup-loading">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</div>';
  callAI('Briefly explain "' + term + '" in simple Arabic. Include: Arabic name, 2-sentence definition, why it matters.', function(info) {
    content.innerHTML = info.replace(/\n/g,'<br>') +
      '<br><a href="https://www.google.com/search?q=' + encodeURIComponent(term+' definition') + '" target="_blank" style="display:inline-block;margin-top:10px;color:var(--accent);font-size:0.78rem">ğŸ”— Ø¬ÙˆØ¬Ù„ â†’</a>';
  });
}

// â”€â”€ AI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function callAI(prompt, callback) {
  if (!ANTHROPIC_KEY) { showKeyModal(); callback('âŒ Ù…Ø­ØªØ§Ø¬ API Key'); return; }
  var context = segments.slice(-8).map(function(s){return s.text;}).join('\n');
  var body = JSON.stringify({
    model: 'claude-haiku-4-5-20251001',
    max_tokens: 600,
    messages: [{
      role: 'user',
      content: context ? '[Transcript]:\n' + context + '\n\n---\n' + prompt : prompt
    }]
  });
  fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': ANTHROPIC_KEY,
      'anthropic-version': '2023-06-01',
      'anthropic-dangerous-direct-browser-access': 'true'
    },
    body: body
  })
  .then(function(resp) {
    if (resp.status === 401) {
      ANTHROPIC_KEY = ''; localStorage.removeItem('ll_key');
      callback('âŒ Ø§Ù„Ù€ Key ØºÙ„Ø·ØŒ Ù‡ÙŠØ·Ù„Ø¨Ù‡ ØªØ§Ù†ÙŠ');
      showKeyModal();
      return;
    }
    return resp.json();
  })
  .then(function(d) {
    if (d && d.content && d.content[0]) callback(d.content[0].text);
    else callback('âŒ Ù…Ø§ Ø¬Ø§Ø´ Ø±Ø¯');
  })
  .catch(function() { callback('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„'); });
}

function sendChat() {
  var inp = document.getElementById('chatInput');
  var msg = inp.value.trim();
  if (!msg) return;
  inp.value = '';
  addChatMsg(msg, 'user');
  document.getElementById('sendBtn').disabled = true;
  var loadEl = addChatMsg('â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙÙƒÙŠØ±...', 'assistant loading');
  callAI('You are a helpful Arabic study assistant. Student asks: ' + msg + '\n\nAnswer in Arabic clearly.', function(resp) {
    loadEl.textContent = resp;
    loadEl.classList.remove('loading');
    document.getElementById('sendBtn').disabled = false;
  });
}

function addChatMsg(text, role) {
  var c = document.getElementById('chatMessages');
  var el = document.createElement('div');
  el.className = 'chat-msg ' + role;
  el.textContent = text;
  c.appendChild(el);
  c.scrollTop = c.scrollHeight;
  return el;
}

function handleChatKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); }
}

// â”€â”€ YOUTUBE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fetchYTTranscript() {
  var url = document.getElementById('ytInput').value.trim();
  var status = document.getElementById('ytStatus');
  var m = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/);
  if (!m) { status.textContent = 'âŒ Ø±Ø§Ø¨Ø· YouTube ØºÙ„Ø·'; return; }
  var vidId = m[1];
  status.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù€ captions...';
  fetch('https://corsproxy.io/?' + encodeURIComponent('https://www.youtube.com/watch?v=' + vidId))
    .then(function(r) { return r.text(); })
    .then(function(html) {
      var match = html.match(/"captionTracks":\[.*?"baseUrl":"(.*?)"/);
      if (!match) { status.textContent = 'âŒ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ø´ ÙÙŠÙ‡ captions Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ'; return; }
      var capUrl = match[1].replace(/\\u0026/g,'&').replace(/\\/g,'');
      return fetch('https://corsproxy.io/?' + encodeURIComponent(capUrl));
    })
    .then(function(r) { return r && r.text(); })
    .then(function(xml) {
      if (!xml) return;
      var parser = new DOMParser();
      var doc = parser.parseFromString(xml, 'text/xml');
      var nodes = doc.querySelectorAll('text');
      if (!nodes.length) { document.getElementById('ytStatus').textContent = 'âŒ Ù…Ø§ Ù„Ù‚ÙŠÙ†Ø§Ø´ Ù†Øµ'; return; }
      var buffer = ''; var wc = 0;
      document.getElementById('emptyState') && document.getElementById('emptyState').remove();
      nodes.forEach(function(node) {
        var raw = node.textContent.replace(/&#39;/g,"'").replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/<[^>]*>/g,'').trim();
        if (!raw) return;
        buffer += (buffer ? ' ' : '') + raw;
        wc += raw.split(' ').length;
        if (wc >= 20) { addSegment(buffer); buffer = ''; wc = 0; }
      });
      if (buffer) addSegment(buffer);
      document.getElementById('ytStatus').textContent = 'âœ… ØªÙ…! ' + segments.length + ' ÙÙ‚Ø±Ø©';
      document.getElementById('ytBar').style.display = 'none';
    })
    .catch(function(e) { document.getElementById('ytStatus').textContent = 'âŒ ÙØ´Ù„: ' + e.message; });
}

// â”€â”€ SAVED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSaved() {
  var panel = document.getElementById('savedList');
  if (!savedItems.length) {
    panel.innerHTML = '<p style="color:var(--text-dim);font-size:0.82rem;text-align:center;padding:20px 0">Ù„Ø³Ù‡ Ù…Ø§Ø­ÙØ¸ØªÙŠØ´ Ø­Ø§Ø¬Ø© ğŸ“Œ</p>';
    return;
  }
  panel.innerHTML = '';
  var reversed = savedItems.slice().reverse();
  reversed.forEach(function(item, ri) {
    var i = savedItems.length - 1 - ri;
    var el = document.createElement('div');
    el.className = 'saved-item';
    el.innerHTML =
      '<div class="saved-item-text">' + item.text + '</div>' +
      '<div class="saved-item-time">â±ï¸ ' + item.time + '</div>' +
      '<div class="saved-item-actions">' +
        '<button class="seg-btn" onclick="explainSavedItem(' + i + ')">ğŸ¤– ÙØ³Ù‘Ø±</button>' +
        '<button class="seg-btn" onclick="navigator.clipboard.writeText(savedItems[' + i + '].text)">ğŸ“‹</button>' +
        '<button class="seg-btn" onclick="savedItems.splice(' + i + ',1);renderSaved()">ğŸ—‘ï¸</button>' +
      '</div>';
    panel.appendChild(el);
  });
}

function explainSavedItem(i) {
  switchTab('chat');
  addChatMsg('ÙØ³Ù‘Ø±Ù„ÙŠ: "' + savedItems[i].text + '"', 'user');
  callAI('Explain this to an Arabic student in simple Arabic:\n\n"' + savedItems[i].text + '"', function(r) {
    addChatMsg(r, 'assistant');
  });
}

// â”€â”€ CONTROLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleListening() {
  if (!isListening) startListening();
  else if (isPaused) resumeListening();
  else stopListening();
}

function startListening() {
  recognition = initRecognition();
  if (!recognition) return;
  sessionFired = false;
  recognition.start();
  isListening = true;
  isPaused = false;
  updateUI();
  showNotification('ğŸ™ï¸ Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹');
}

function stopListening() {
  if (recognition) { try { recognition.stop(); } catch(e) {} recognition = null; }
  isListening = false; isPaused = false;
  if (interimEl) { interimEl.remove(); interimEl = null; }
  updateUI();
  showNotification('â¹ï¸ ØªÙˆÙ‚Ù');
}

function pauseResume() {
  if (!isListening) return;
  if (!isPaused) {
    if (recognition) { try { recognition.stop(); } catch(e) {} }
    isPaused = true;
  } else {
    resumeListening();
  }
  updateUI();
}

function resumeListening() {
  if (!recognition) recognition = initRecognition();
  try { recognition.lang = document.getElementById('langSelect').value; recognition.start(); } catch(e) {}
  isPaused = false;
  updateUI();
}

function updateUI() {
  var btn = document.getElementById('micBtn');
  var dot = document.getElementById('statusDot');
  var st  = document.getElementById('statusText');
  var pb  = document.getElementById('pauseBtn');
  var mi  = document.getElementById('micIcon');
  var ml  = document.getElementById('micLabel');
  btn.classList.remove('listening','paused-state');
  dot.classList.remove('active','paused');
  if (isListening && !isPaused) {
    btn.classList.add('listening'); dot.classList.add('active');
    st.textContent='ÙŠØ³ØªÙ…Ø¹...'; mi.textContent='â¹ï¸'; ml.textContent='Ø¥ÙŠÙ‚Ø§Ù';
    pb.disabled=false; pb.textContent='â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª';
  } else if (isListening && isPaused) {
    btn.classList.add('paused-state'); dot.classList.add('paused');
    st.textContent='Ù…ØªÙˆÙ‚Ù Ù…Ø¤Ù‚ØªØ§Ù‹'; mi.textContent='â–¶ï¸'; ml.textContent='Ø§Ø³ØªÙ…Ø±Ø§Ø±';
    pb.textContent='â–¶ï¸ Ø§Ø³ØªÙ…Ø±Ø§Ø±'; pb.disabled=false;
  } else {
    st.textContent='Ù…ØªÙˆÙ‚Ù'; mi.textContent='ğŸ™ï¸'; ml.textContent='Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹';
    pb.disabled=true; pb.textContent='â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª';
  }
}

function clearTranscript() {
  if (!confirm('Ù‡ØªÙ…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù†ØµØŸ')) return;
  segments=[]; segmentCounter=0; activeSegId=null;
  clearTimeout(silenceTimer); detectedTerms={};
  document.getElementById('termsList').innerHTML = '<p style="color:var(--text-dim);font-size:0.82rem;text-align:center;padding:20px 0">Ø§Ù„Ù…ØµØ·Ù„Ø­Ø§Øª Ù‡ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ ğŸ“š</p>';
  document.getElementById('transcriptContent').innerHTML = '<div class="empty-state" id="emptyState"><div class="empty-icon">ğŸ™ï¸</div><h3>ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©</h3><p>Ø§Ø¶ØºØ· Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ø£Ùˆ Ø­Ø· Ø±Ø§Ø¨Ø· YouTube</p></div>';
  showNotification('ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ù…Ø³Ø­');
}

function copyAll() {
  var text = segments.map(function(s){return '['+s.time+'] '+s.text;}).join('\n\n');
  navigator.clipboard.writeText(text).then(function(){showNotification('âœ… Ù†ÙØ³Ø® Ø§Ù„ÙƒÙ„');});
}

function toggleAutoTerms() {
  autoTermsEnabled = !autoTermsEnabled;
  document.getElementById('showTermsBtn').textContent = autoTermsEnabled ? 'ğŸ” Ø§Ù„Ù…ØµØ·Ù„Ø­Ø§Øª' : 'ğŸ” Ù…ØªÙˆÙ‚ÙØ©';
}

// â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name) {
  var tabs = document.querySelectorAll('.tab');
  var names = ['chat','saved','terms'];
  for (var i=0;i<tabs.length;i++) tabs[i].classList.toggle('active', names[i]===name);
  var contents = document.querySelectorAll('.tab-content');
  for (var j=0;j<contents.length;j++) contents[j].classList.toggle('active', contents[j].id==='tab-'+name);
}

// â”€â”€ NOTIFICATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showNotification(msg) {
  var el = document.getElementById('notification');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(function(){el.classList.remove('show');}, 2500);
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
updateUI();
</script>
</body>
</html>